// softcatala
// Xavi Ivars, Toni Hermoso

document.apertium_loaded = false;

$.fn.limitMaxlength = function(options){

	var settings = $.extend({
		attribute: "maxlength",
		onLimit: function(){},
		onEdit: function(){}
	}, options);

	// Event handler to limit the textarea
	var onEdit = function(){
		var textarea = $(this);
		var maxlength = parseInt(textarea.attr(settings.attribute));

		if(textarea.val().length > maxlength){
			textarea.val(textarea.val().substr(0, maxlength));

			// Call the onlimit handler within the scope of the textarea
			$.proxy(settings.onLimit, this)();
		}

		// Call the onEdit handler within the scope of the textarea
		$.proxy(settings.onEdit, this)(maxlength - textarea.val().length);
	}

	this.each(onEdit);

	return this.keyup(onEdit)
				.keydown(onEdit)
				.focus(onEdit);
}

function SelectText(element) {
    var text = document.getElementById(element);
    if ($.browser.msie) {
        var range = document.body.createTextRange();
        range.moveToElementText(text);
        range.select();
    } else if ($.browser.mozilla || $.browser.opera) {
        var selection = window.getSelection();
        var range = document.createRange();
        range.selectNodeContents(text);
        selection.removeAllRanges();
        selection.addRange(range);
    } else if ($.browser.webkit || $.browser.safari ) {
        var selection = window.getSelection();
        selection.setBaseAndExtent(text, 0, text, 1);
    }
}


function nl2br(text){
	text=escape(text);
	return unescape(text.replace(/(%5Cr%5Cn)|(%5Cn%5Cr)|%0A|%5Cr|%5Cn/g,'<br />'));
}


$(document).ready(function(){
	// document.apertium_loaded = true;

	$('#avis_softvalencia').hide();
	$('#botons_traductor').show();
	if(typeof $.proxy != 'undefined')
		$('#sl').limitMaxlength();

	//localStorage.clear();
	getLocalStorage();

	$("#ftraductor").submit(function(){
			var langpair = $('#langpair option:selected').val().replace('-','|');

			if((langpair=='es|ca')&&($('#valencia:checked').length))langpair=langpair+'_valencia';
			var muk = ($('#unknown:checked').length)?'yes':'no';
			var txt = $('#sl').val();

			if(!txt.length) return false;

			// First we check if service is available. Softcatalà servers
			var checkurl = "http://www.softcatala.org/app/online.php";
			$.ajax({
				url:checkurl,
				type:"GET",
				dataType:"jsonp",
				crossDomain: "true",
				timeout:2000,
				async:true,
				success:function(data, status){
                                        $.ajax({
                                                url:"http://www.softcatala.org/apertium/json/translate", //URL of translator
                                                type:"POST",
                                                data : {'langpair':langpair,'q':txt,'markUnknown':muk,'key':'ZjI4NjFkYzZmOWU1NTdkOWUyOWE'},
                                                dataType: 'jsonp',
                                                success : trad_ok,
                                                failure : trad_ko
                                        });
				},
				error:function(x, t, m){
					$('#warninternet').append('<p>No hi ha connexió!</p>');
					$('#warninternet').show('slow');
					$('#warninternet').hide(5000, function() {
						$('#warninternet').empty();
					});
				}
			});


			return false;
	});



	function trad_ko() {
		$('#trad_info').html(': <span style="font-size:0.8em;color:red;font-weight:bold">ERROR EN LA TRADUCCIÓ</span>');
		$('#traduccio').hide();
	}

	function trad_ok(dt) {
		if(dt.responseStatus==200) {
			//$('#traduccio').html('<pre style"white-space: pre-wrap; word-wrap: break-word;">'+dt.responseData.translatedText+'</pre>');
			//$('#traduccio').html(nl2br(dt.responseData.translatedText));
			$('#traduccio').html(dt.responseData.translatedText);
			$('#traduccio').show();
			$('#trad_info').html('');
			$('#dv_traduccio').show(500);

			//Store locally last langpair
			if (localStorage) {
				var prefix = "trada";
				var msec = new Date().getTime();
				localStorage.setItem(prefix+"-"+msec+'-langpair', $('#langpair option:selected').val());
				localStorage.setItem(prefix+"-"+msec+'-valencia', 'false');
				localStorage.setItem(prefix+"-"+msec+'-unknown', 'false');
				localStorage.setItem(prefix+"-"+msec+'-txt', '');
				localStorage.setItem(prefix+"-"+msec+'-traduccio', '');							

				var txt = $('#sl').val();
				var traduccio = $('#traduccio').val();

				if ($('#valencia:checked').length) {
					localStorage.setItem(prefix+"-"+msec+'-valencia', 'true');
				}
				if ($('#unknown:checked').length) {
					localStorage.setItem(prefix+"-"+msec+'-unknown', 'true');
				}
				if (txt.length >0) {
					localStorage.setItem(prefix+"-"+msec+'-txt', txt);
				}
				if (traduccio.length >0) {
					localStorage.setItem(prefix+"-"+msec+'-traduccio', traduccio);
				}
			}

			//Reset localStorage
			getLocalStorage();
			// Reset clear all if was enabled
			if ($('.list').is(':visible')) {
				if ($('.list').children().length > 0) {
					$('#netejahistorial').show();
				}
			}


			var target_offset = $("#traduccio").offset();
			var target_top = target_offset.top;
			$('html, body').animate({scrollTop:target_top}, 500);

			$('.link_select span').click(function(){ SelectText('traduccio'); });
		} else {
				trad_ko();
		}
	}

	$('#langpair').change(function(){
			if($('#langpair option:selected').val()=='es-ca') {
					$('#sp_valencia').show();
			} else {
					$('#sp_valencia').hide();
			}
	});
	
	$('#neteja').click(function(){
		$('#sl').val('');
		$('#dv_traduccio').hide(500);
		$('#traduccio').html('');
	});

	$('#sl').focus();

        $(".select").live('click', function() {
		var prefix = "trada";
                var splitkey = $(this).attr('id').split('-', 2);
                var langpair = prefix+"-"+splitkey[1]+"-langpair";
                var valencia = prefix+"-"+splitkey[1]+"-valencia"
                var unknown = prefix+"-"+splitkey[1]+"-unknown";
                var txt = prefix+"-"+splitkey[1]+"-txt";
                var traduccio = prefix+"-"+splitkey[1]+"-traduccio";

                //Put used params
                if (localStorage[langpair]) {
                        $('#langpair').val(localStorage[langpair]);
                }
                if (localStorage[valencia] == 'true') {
                        $('#valencia').attr('checked', true);
                }
                if (localStorage[unknown] == 'true') {
                        $('#unknown').attr('checked', true);
                }
                if (localStorage[txt]) {
                        $('#sl').val(localStorage[txt]);
                }
                if (localStorage[traduccio]) {
                        $('#traduccio').html(localStorage[traduccio]);
                        $('#traduccio').show();
                        $('#trad_info').html('');
                        $('#dv_traduccio').show(500);
                }
        });

        $(".remove").live('click', function() {
		var prefix = "trada";
                var splitkey = $(this).attr('id').split('-', 2);
                var langpair = prefix+"-"+splitkey[1]+"-langpair";
                var valencia = prefix+"-"+splitkey[1]+"-valencia"
                var unknown = prefix+"-"+splitkey[1]+"-unknown";
                var txt = prefix+"-"+splitkey[1]+"-txt";
                var traduccio = prefix+"-"+splitkey[1]+"-traduccio";

                localStorage.removeItem(langpair);
                localStorage.removeItem(valencia);
                localStorage.removeItem(unknown);
                localStorage.removeItem(txt);
                localStorage.removeItem(traduccio);

                $(this).parent().parent().remove();
        });

	$(".clear-history").live('click', function() {
		//Remove storage with certain prefix
		clearStorage("trada");
		$('.list').hide();
		$('.list > *').remove();
		$('#netejahistorial').hide();
	});


});

function sortObj(arr){
	// Setup Arrays
	var sortedKeys = new Array();
	var sortedObj = {};

	// Separate keys and sort them
	for (var i in arr){
		sortedKeys.push(i);
	}
	sortedKeys.sort();

	// Reconstruct sorted obj based on keys
	for (var i in sortedKeys){
		sortedObj[sortedKeys[i]] = arr[sortedKeys[i]];
	}
	return sortedObj;
}

function clearStorage(cprefix) {

	var toRemove = new Array();
	//Assumes there is prefix - separated;
	for (i=0; i<=localStorage.length-1; i++)  {
		// get the key
                key = localStorage.key(i);
                // split the key
                var splitkey = key.split('-', 3);
                var prefix = splitkey[0];
                if (prefix == cprefix) { //Only remove if prefix
			toRemove.push(key);
		}
	}

	// Remove actual values
	for (a=0; a<=toRemove.length-1; a++) {
		localStorage.removeItem(toRemove[a]);
	}
}

function clearStorageSet(cprefix, cbase) {

	var toRemove = new Array();
        //Assumes there is prefix - separated;
        for (i=0; i<=localStorage.length-1; i++)  {
                // get the key
                key = localStorage.key(i);
                // split the key
                var splitkey = key.split('-', 3);
                var prefix = splitkey[0];
		var base = splitkey[1];
                if ((prefix == cprefix) && (base == cbase)) { //Only remove if prefix
                        toRemove.push(key);
                }
        }

        // Remove actual values
        for (a=0; a<=toRemove.length-1; a++) {
                localStorage.removeItem(toRemove[a]);
        }
}


function getLocalStorage() {

        var localSaved = new Array();
	var cprefix = "trada"; //Used for restricting;

	if (localStorage.length > 0) {

		//First get all localstore into in array
		for (i=0; i<=localStorage.length-1; i++)  {
		        // get the key
		        key = localStorage.key(i);
		        // split the key
		        var splitkey = key.split('-', 3);
			var prefix = splitkey[0];
			if (prefix == cprefix) { //Only save if prefix
		        	var base = splitkey[1];
		        	var attr = splitkey[2];
		        	if (!localSaved[base]) {localSaved[base] = new Array();}

		        	localSaved[base][attr] = localStorage.getItem(key);
		        	localSaved[base]['id'] = base;
			}
		}

		//Now act in array

		var numeric_array = new Array();
		for (var item in sortObj(localSaved)){
		        numeric_array.push( localSaved[item] );
		}
		var lastSaved = numeric_array[(numeric_array.length -1)];
		if (lastSaved) {
		//Put last used language
		if (lastSaved['langpair']) {
		                $('#langpair').val(lastSaved['langpair']);
		}
		if (lastSaved['valencia'] == 'true') {
		                $('#valencia').attr('checked', true);
		}
		if (lastSaved['unknown'] == 'true') {
		                $('#unknown').attr('checked', true);
		}
		//if (lastSaved['txt']) {
		//                $('#sl').val(lastSaved['txt']);
		//}
		//Not available in reload
		//if (lastSaved['traduccio']) {
		//		$('#traduccio').html(lastSaved['traduccio']);
		//		$('#traduccio').show();
		//              $('#trad_info').html('');
		//              $('#dv_traduccio').show(500);
		//}
		}


		//Remove previous
		$('.list > *').remove();
	
		//Clean repeated
		var testclean = 0;	
		var indexremoved;

		for (var item in numeric_array.reverse()){

			var pos = numeric_array.length - item -1;
			if (numeric_array[pos-1]) {
				var counter = 0;
	
				if (numeric_array[pos]['txt'] == numeric_array[pos-1]['txt']) {
					counter++;
				}
				if (numeric_array[pos]['langpair'] == numeric_array[pos-1]['langpair']) {
					counter++;
				}
			
				if (counter > 1) {
					testclean = 1;
					indexremoved = pos-1;
					break;					
				}
			}
		}

		if (testclean == 1) {
			//Clean repeated
			numeric_array.splice(indexremoved, 1);
			clearStorageSet('trada', numeric_array[indexremoved]['id']);
		}

	
		//Here remove any value higher in the stack
		//TODO -> limit 25?
		var limitarray = 25;
		if (numeric_array.length > limitarray) {
			clearStorageSet('trada', numeric_array[limitarray]['id']);
			numeric_array.pop();
		}

		//Fill history div
		for (var item in numeric_array){
		        //Limit size of string
		
		        var txt2show = numeric_array[item]['txt'].substr(0, 25) + "...";
			//var txt2show = numeric_array[item]['txt'];

		        var string = '<p class="histitem"><a href="#" class="select" id="select-'+numeric_array[item]['id']+'"><img src="img/select.png" alt="Select" title="Select" /></a><span class="txt"><a href="#" class="select" id="selecta-'+numeric_array[item]['id']+'">'+txt2show+'</a></span><a href="#history" class="remove" id="remove-'+numeric_array[item]['id']+'"><img class="remove" id="remove-'+numeric_array[item]['id']+'" src="img/remove.gif" alt="Remove" title="Remove" /></a></p>';
		        $('.list').append(string);

		}
	}
}

